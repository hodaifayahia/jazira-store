

# Inventory Management Page (`/admin/inventory`)

## Overview
Create a dedicated stock management page that provides a product-level table with expandable per-variant inventory details, inline stock editing, search, filtering, and column customization. This separates inventory concerns from product catalog management.

## Current State
- Product stock is stored in `products.stock` (integer, for simple products)
- Variant stock is in `product_variants.quantity` (integer, per variant row)
- Products with `has_variants=true` use the variant system; others use the product-level `stock` field
- No dedicated inventory page exists -- stock is edited via the product form
- Low stock notifications already exist in AdminLayout (threshold: 5)

## What Gets Built

### New Page: `src/pages/admin/AdminAbandonedPage.tsx` -> `src/pages/admin/AdminInventoryPage.tsx`

**KPI Summary Cards** (4 cards at top):
- Total Products (count of all active products)
- Out of Stock (products where stock = 0 or all variants have quantity = 0)
- Low Stock (stock between 1-5, or any variant with quantity 1-5)
- Total Inventory Value (SUM of stock x price across all products/variants)

**Product Table** with columns:
- Product Image (first image from `images` array)
- Product Name
- SKU Code
- Total Quantity (product.stock for simple, SUM of variant quantities for variant products)
- Price (DZD)
- Status indicator (color dot: green = in stock, yellow = low, red = out of stock)

**Column Display Settings**:
- A "Display Settings" button opening a popover with checkboxes to toggle each column's visibility
- Preference saved in localStorage

**Search**: Filter by product name or SKU

**Filter Tabs**: All / In Stock / Low Stock (1-5) / Out of Stock (0)

**Expandable Variant Details** per product row:
- For products with `has_variants=true`: Shows variant matrix table with columns: Variant Label (from `option_values` JSONB), Price, Quantity, Actions
- For simple products: Shows single row labeled "المنتج الأساسي" (Base Product) with "قياس موحد" (Unified Size)

**Per-Row Actions**:
- **Edit** (inline quantity/price editing with save/cancel)
- **Add Stock** (increment dialog: enter amount to add)

**Pagination**: 15 items per page with Previous/Next navigation

## Database Changes
No database migration needed. The page reads and writes to existing `products` and `product_variants` tables.

## Stock Update Logic

### Simple Products (has_variants = false)
- Edit: `UPDATE products SET stock = :newValue WHERE id = :id`
- Add Stock: `UPDATE products SET stock = stock + :amount WHERE id = :id`

### Variant Products (has_variants = true)
- Edit: `UPDATE product_variants SET quantity = :newValue WHERE id = :variantId`
- Add Stock: `UPDATE product_variants SET quantity = quantity + :amount WHERE id = :variantId`
- After any variant update, sync the parent `products.stock` = SUM of all variant quantities

## Technical Details

### Files to Create
- `src/pages/admin/AdminInventoryPage.tsx` -- Complete inventory management page

### Files to Modify
- `src/App.tsx` -- Add route `/admin/inventory`
- `src/components/AdminLayout.tsx` -- Add "إدارة المخزون" nav item with `Package` or `Layers` icon, placed after "المنتجات"

### Data Fetching
- Fetch all products: `supabase.from('products').select('*').order('created_at', { ascending: false })`
- Fetch all variants: `supabase.from('product_variants').select('*')` -- loaded once and grouped by `product_id` client-side
- This avoids N+1 queries (one per product expansion)

### Variant Label Display
The `option_values` JSONB in `product_variants` stores the combination (e.g., `{ "Color": "Red", "Size": "XL" }`). The variant label will be generated by joining the values: "Red / XL".

### Inline Editing UX
1. Click "تعديل" (Edit) on a variant row
2. Quantity and price cells become editable inputs
3. Show Save (check icon) and Cancel (X icon) buttons
4. On save: update the database, invalidate query cache, show success toast
5. On cancel: revert to original values

### Add Stock Dialog
1. Click "إضافة مخزون" on a variant row
2. Small inline input appears with a number field (default: 1)
3. Confirm adds the amount atomically
4. Toast shows: "تم إضافة X وحدة" (Added X units)

### Column Visibility
- Stored in `localStorage` key `inventory_column_prefs`
- Default: all columns visible
- Toggle via a popover with checkboxes for each column

### Stock Status Calculation
- Out of Stock: quantity = 0
- Low Stock: quantity > 0 AND quantity <= 5
- In Stock: quantity > 5
- For variant products: status based on the total SUM of variant quantities

### Mobile Responsive
- On mobile, table switches to card layout (same pattern used in other admin pages)
- Each card shows product image, name, total stock with status badge, and expand button for variants

